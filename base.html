<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Title of the document</title>
    <script src="vue.js"></script>
    <style>
      body {
        --color-one: rgb(81,130,187);
        --color-two: rgb(237,242,248);
        --color-three: rgb(186, 205, 228);
        --color-four: rgb(245, 227, 83);
        --header-height: 3em;
      }
      div.header {
        display: flex;
        flex-direction: row;
        height: var(--header-height);
        position: relative;
        font-size: 1.5em;
        background: var(--color-one);
        border: 1px solid var(--color-one);
        align-items: center;
        color: white;
        border-radius: 0.25em 0 0 0.25em;
        overflow: hidden;
      }
      div.header div.logo {
        flex: 0 0 auto;
        height: var(--header-height);
        width: 4em;
        text-align: center;
        line-height: var(--header-height);
        border-right: 1px solid white;
        border-radius: 0.25em;
        overflow: hidden;
        padding-right: 0.25em;
        background: rgb(13,95,169);
          color: #ddd;
      }
      div.header div.title {
        padding-left: 0.5em;
        font-size: 0.95em;
      }
      div.header div.number {
        flex: 0 0 10%;
        background: var(--color-four);
        color: var(--color-one);
        height: 100%;
        text-align: center;
        line-height: var(--header-height);
        margin-left: auto;
      }
      div.instructions {
        padding: 1em;
          font-size: 0.75em;
      }
      div.checkbox {
        display: flex;
        flex-flow: row;
        flex-wrap: nowrap;
      }
      label.checkbox {
        flex: 1 1 auto;
      }
      input[type="checkbox"].checkbox {
        flex: 1 1 auto;
      }
      table {
        border: 1px solid var(--color-one);
      }
      td {
        border: 0px solid white;
      }

      td.questionNumber {
        padding: 0.5em;
        font-size: 1.25em;
      }

      td.questionText {
        padding-left: 0.5em;
      }

      td.questionPartText {
        padding-left: 1em;
      }

      th {
        background: var(--color-one);
        border: 1px solid white;
        color: white;
      }
      tr:nth-child(even) {
        background-color: var(--color-three);
      }
      tr:nth-child(odd) {
        background-color: var(--color-two);
      }

      button.export {
        font-variant: small-caps;
        font-size: 125%;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <select v-model="activeCard" @change="cardSelected">
        <option v-for="(card, cIdx) in cards" :value="cIdx">{{card.number}} : {{ card.name }}</option>
      </select>
      <div class="header">
        <div class="logo"><i>logo</i></div>
        <div class="title">{{ surveyTitle }}</div>
        <div class="number">{{ surveyNumber }}</div>
      </div>

      <div class="instructions">
        <b>Instructions</b>: {{ surveyInstructions }}
      </div>

      <table v-for="(section, sIdx) in sections">
        <template v-if="observables.length > 1">
          <thead>
            <tr>
              <th rowspan="2" colspan="2">{{ section.questionHeader }}</th>
              <th rowspan="2" colspan="1" v-for="observable in observables">{{ observable }}</th>
              <th rowspan="1" colspan="2"> Summary Of Observations </th>
            </tr>
            <tr>
              <th>Yes</th>
              <th>Total Observed</th>
            </tr>
          </thead>

          <tfoot v-if="sIdx === sections.length-1"> <!--TODO: Move this conditional logic to a helper function -->
            <th :colspan="observables.length + 2">Total Yes and Total Observed</th>
            <td align="center"> {{ totalYes }} </td>
            <td align="center"> {{ totalObserved }}</td>
          </tfoot>

          <tbody>
            <tr v-for="(q, qIdx) in section.questions">
              <td class="questionNumber">{{ q.number }}</td>
              <td class="questionText" >{{ q.text }}</td>
              <td v-for="(o, oIdx) in q.observations">
                <template v-for="(c, cIdx) in q.choices">
                  <div class="checkbox">
                    <input class="checkbox" id="checkbox_id(qIdx, oIdx, cIdx)" type="checkbox" v-model="o[c]" @change="enforceChoice(o, c)">
                    <label class="checkbox" for="checkbox_id(qIdx, oIdx, cIdx)" >{{ c }}</label>
                  </div>
                </template>
              </td>
              <td align="center">
                {{ countQuestionObservation(q, "Yes") }}
              </td>
              <td align="center">
                {{ countQuestionObserved(q) }}
              </td>
            </tr>
          </tbody>
        </template>
        <template v-else>
          <thead>
            <tr>
              <th rowspan="1" colspan="2">{{ section.questionHeader }}</th>
              <th rowspan="1" colspan="3"> Summary Of Observations </th>
            </tr>
          </thead>

          <tbody>
            <template v-for="(q, qIdx) in section.questions">
              <tr v-if="q.choices">
                <td class="questionNumber">{{ q.number }}</td>
                <td class="questionText" >{{ q.text }}</td>
                <td v-for="(c, cIdx) in q.choices">
                  <div class="checkbox">
                    <input class="checkbox" id="checkbox_id(qIdx, 0, cIdx)" type="checkbox" v-model="q.observations[0][c]" @change="enforceChoice(q.observations[0], c)">
                    <label class="checkbox" for="checkbox_id(qIdx, 0, cIdx)" >{{ c }}</label>
                  </div>
                </td>
              </tr>
              <template v-if="q.parts">
              <tr>
                <td class="questionNumber" :rowspan="q.parts.length+1">{{ q.number }}</td>
                <td class="questionText">{{ q.text }}</td>
              </tr>
              <tr v-for="part in q.parts">
                <td class="questionPartText" >{{part.number}}. {{part.text}}</td>
                <td v-for="(c, cIdx) in part.choices">
                  <div class="checkbox">
                    <input class="checkbox" id="checkbox_id(qIdx, 0, cIdx)" type="checkbox" v-model="part.observations[0][c]" @change="enforceChoice(part.observations[0], c)">
                    <label class="checkbox" for="checkbox_id(qIdx, 0, cIdx)" >{{ c }}</label>
                  </div>
                </td>
              </tr>
              </template>
            </template>
          </tbody>

          <tfoot v-if="sIdx === sections.length-1"> <!--TODO: Move this conditional logic to a helper function -->
            <th colspan="2">Total</th>
            <td align="center"> {{ totalYes }} </td>
            <td align="center"> {{ totalNo }} </td>
            <td align="center"> {{ totalNA }} </td>
          </tfoot>
        </template>
      </table>
      <button class="export" @click="exportData">export</button>
    </div>
    <script>
      /*INSERT*/
      function generateModel(survey) {
        function* QuestionNumberGenerator() {
          var value = 1;
          while(true) {
            yield value++;
          }
        };

        function generateObservation(q) {
          const observation = {};
          q.choices.forEach( (choice) => observation[choice] = false );
          return observation;
        }

        function generateQuestion(survey, question, numberGenerator) {
          const text = question.text;

          if (question.choices) {
            const observations = survey.observables.map( (o) => generateObservation(question) );
            const choices = question.choices.map( (c) => c );
            const number = numberGenerator.next().value;

            return {number, text, choices, observations}
          }

          if (question.parts) {
            const observations = [];
            const partNumberGenerator = QuestionNumberGenerator();
            const parts = question.parts.map( (q) => generateQuestion(survey, q, partNumberGenerator) );
            const number = numberGenerator.next().value;
            return {number, text, parts, observations}
          }
        }

        const questionNumberGenerator = QuestionNumberGenerator();
        const sections = survey.sections.map( (s, sIdx) => {
          const questionHeader = s.questionHeader;
          const questions = s.questions.map( (q) => generateQuestion(survey, q, questionNumberGenerator) );
          return {questionHeader, questions};
        });

        return sections;
      }

      var app = new Vue({
        el: '#app',
        data: {
          activeCard: 4,
          sections: [],
        },
        computed: {
          totalYes() {
            return this.sections.reduce( (acc, s) => acc + this.countSectionObservation(s, "Yes"), 0)
          },
          totalNo() {
            return this.sections.reduce( (acc, s) => acc + this.countSectionObservation(s, "No"), 0)
          },
          totalNA() {
            return this.sections.reduce( (acc, s) => acc + this.countSectionObservation(s, "N/A"), 0)
          },
          totalObserved() {
            return this.sections.reduce( (acc, q) => acc + this.countSectionObserved(q), 0)
          },
        },
        methods: {
          cardSelected(evt) {
            this.populate();
          },
          label: (qIdx,rIdx,yesno) => `question-${qIdx}-observable-${rIdx}-${yesno}`,
          enforceChoice(observation, which) {
            const others = Object.keys(observation).filter( (key) => key !== which );
            others.forEach( (other) => observation[other] = false );
          },
          countQuestionObservation(q, choice) {
            if (q.choices) {
              return q.observations.filter( (r) => r[choice] ).length
            }
            if (q.parts) {
              return q.parts.reduce( (acc, p) => acc + this.countQuestionObservation(p, choice), 0);
            }
          },
          countQuestionObserved(q) {
            if (q.choices) {
              return q.observations.filter( (r) => r["Yes"] || r["No"] ).length;
            }
            if (q.parts) {
              return q.parts.reduce( (acc, p) => acc + this.countQuestionObserved(q), 0 );
            }
          },
          countSectionObservation(s, choice) {
            return s.questions.reduce( (acc, q) => acc + this.countQuestionObservation(q, choice), 0);
          },
          countSectionObserved(s) {
            return s.questions.reduce( (acc, q) => acc + this.countQuestionObserved(q), 0);
          },
          csvHeader() {
            const columns = [
              "Observation Number",
              "Observation Category",
              ...this.observables,
              "'Yes' Observed",
              "Total Observed"
            ]
            return columns.join(",");
          },
          csvData() {
            return this.questions.map( (q, idx) => {
              const columns = [
                idx+1,
                `"${q.text}"`,
                ...q.observables.map( (r) => {
                  return r["Yes"] ? "1" : "0";
                }),
                this.countQuestionObservation(q, "Yes"),
                this.countQuestionObserved(q),
                ];
              return columns.join(',');
            })
          },
          generateCSV() {
            const lines = [this.csvHeader(), ... this.csvData()];
            return lines.join("\n");
          },
          exportData() {
            const filename="demo.csv";
            const text = this.generateCSV();
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
          },
          populate() {
            const card = cards[this.activeCard];
            this.surveyTitle = card.title;
            this.surveyInstructions = card.instructions;
            this.surveyNumber = card.number;
            this.observables = card.observables.map( (label) => label );
            this.sections = generateModel(card);
          }
        },
        created() {
          this.populate();
        }
      });
    </script>
  </body>
</html>
