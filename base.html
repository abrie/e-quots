<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Title of the document</title>
    <script src="vue.js"></script>
    <style>
      body {
        --color-one: rgb(81,130,187);
        --color-two: rgb(237,242,248);
        --color-three: rgb(186, 205, 228);
        --color-four: rgb(245, 227, 83);
        --header-height: 3em;
      }
      div.header {
        display: flex;
        flex-direction: row;
        height: var(--header-height);
        position: relative;
        font-size: 1.5em;
        background: var(--color-one);
        border: 1px solid var(--color-one);
        align-items: center;
        color: white;
        border-radius: 0.25em 0 0 0.25em;
        overflow: hidden;
      }
      div.header div.logo {
        flex: 0 0 auto;
        height: var(--header-height);
        width: 4em;
        text-align: center;
        line-height: var(--header-height);
        border-right: 1px solid white;
        border-radius: 0.25em;
        overflow: hidden;
        padding-right: 0.25em;
        background: rgb(13,95,169);
          color: #ddd;
      }
      div.header div.title {
        padding-left: 0.5em;
        font-size: 0.95em;
      }
      div.header div.number {
        flex: 0 0 10%;
        background: var(--color-four);
        color: var(--color-one);
        height: 100%;
        text-align: center;
        line-height: var(--header-height);
        margin-left: auto;
      }
      div.instructions {
        padding: 1em;
          font-size: 0.75em;
      }
      div.checkbox {
        display: flex;
        flex-flow: row;
        flex-wrap: nowrap;
      }
      label.checkbox {
        flex: 1 1 auto;
      }
      input[type="checkbox"].checkbox {
        flex: 1 1 auto;
      }
      table {
        border: 1px solid var(--color-one);
      }
      td {
        border: 0px solid white;
      }
      th {
        background: var(--color-one);
        border: 1px solid white;
        color: white;
      }
      tr:nth-child(even) {
        background-color: var(--color-three);
      }
      tr:nth-child(odd) {
        background-color: var(--color-two);
      }

      button.export {
        font-variant: small-caps;
        font-size: 125%;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <select v-model="activeCard" @change="cardSelected">
        <option v-for="(card, cIdx) in cards" :value="cIdx">{{card.number}} : {{ card.name }}</option>
      </select>
      <div class="header">
        <div class="logo"><i>logo</i></div>
        <div class="title">{{ surveyTitle }}</div>
        <div class="number">{{ surveyNumber }}</div>
      </div>

      <div class="instructions">
        <b>Instructions</b>: {{ surveyInstructions }}
      </div>

      <table v-for="(section, sIdx) in sections">
        <thead>
          <tr>
            <th rowspan="2" colspan="2">{{ section.questionHeader }}</th>
            <th rowspan="2" colspan="1" v-for="observable in observables">{{ observable }}</th>
            <th rowspan="1" colspan="2"> Summary Of Observations </th>
          </tr>
          <tr>
            <th>Yes</th>
            <th>Total Observed</th>
          </tr>
        </thead>

        <tfoot v-if="sIdx === sections.length-1"> <!--TODO: Move this conditional logic to a helper function -->
          <th :colspan="observables.length + 2">Total Yes and Total Observed</th>
          <td align="center"> {{ totalYes }} </td>
          <td align="center"> {{ totalObserved }}</td>
        </tfoot>

        <tbody>
        <tr v-for="(q, qIdx) in section.questions">
          <td>{{ q.number }}</td>
          <td>{{ q.text }}</td>
          <td v-for="(o, oIdx) in q.observations">
            <template v-for="(c, cIdx) in q.choices">
              <div class="checkbox">
                <input class="checkbox" id="checkbox_id(qIdx, oIdx, cIdx)" type="checkbox" v-model="o[c]" @change="enforceChoice(o, c)">
                <label class="checkbox" for="checkbox_id(qIdx, oIdx, cIdx)" >{{ c }}</label>
              </div>
            </template>
          </td>
          <td align="center">
            {{ countQuestionObservation(q, "Yes") }}
          </td>
          <td align="center">
            {{ countQuestionObserved(q) }}
          </td>
        </tr>
        </tbody>
      </table>
      <button class="export" @click="exportData">export</button>
    </div>
    <script>
      /*INSERT*/
      function generateModel(survey) {
        var questionNumber = 1;

        const sections = survey.sections.map( (s, sIdx) => {
          const questionHeader = s.questionHeader;
          const questions = s.questions.map( (q, idx) => {
            const text = q.text;
            const observations = [];
            const choices = q.choices.map( (c) => c );
            for (let i = 0; i < survey.observables.length; i++) {
              const observation = {};
              q.choices.forEach( (choice) => observation[choice] = false );
              observations.push(observation);
            }

            return {number:questionNumber++, text, choices, observations}
          });

          return {questionHeader, questions};
        });

        return sections;
      }

      var app = new Vue({
        el: '#app',
        data: {
          activeCard: 0,
          sections: [],
        },
        computed: {
          totalYes() {
            return this.sections.reduce( (acc, s) => acc + this.countSectionObservation(s, "Yes"), 0)
          },
          totalObserved() {
            return this.sections.reduce( (acc, q) => acc + this.countSectionObserved(q), 0)
          },
        },
        methods: {
          cardSelected(evt) {
            this.populate();
          },
          label: (qIdx,rIdx,yesno) => `question-${qIdx}-observable-${rIdx}-${yesno}`,
          enforceChoice(observation, which) {
            const others = Object.keys(observation).filter( (key) => key !== which );
            others.forEach( (other) => observation[other] = false );
          },
          countQuestionObservation: (q, choice) => q.observations.filter( (r) => r[choice] ).length,
          countQuestionObserved: (q) => q.observations.filter( (r) => r["Yes"] || r["No"] ).length,
          countSectionObservation(s, choice) {
            return s.questions.reduce( (acc, q) => acc + this.countQuestionObservation(q, choice), 0);
          },
          countSectionObserved(s) {
            return s.questions.reduce( (acc, q) => acc + this.countQuestionObserved(q), 0);
          },
          csvHeader() {
            const columns = [
              "Observation Number",
              "Observation Category",
              ...this.observables,
              "'Yes' Observed",
              "Total Observed"
            ]
            return columns.join(",");
          },
          csvData() {
            return this.questions.map( (q, idx) => {
              const columns = [
                idx+1,
                `"${q.text}"`,
                ...q.observables.map( (r) => {
                  return r["Yes"] ? "1" : "0";
                }),
                this.countQuestionObservation(q, "Yes"),
                this.countQuestionObserved(q),
                ];
              return columns.join(',');
            })
          },
          generateCSV() {
            const lines = [this.csvHeader(), ... this.csvData()];
            return lines.join("\n");
          },
          exportData() {
            const filename="demo.csv";
            const text = this.generateCSV();
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
          },
          populate() {
            const card = cards[this.activeCard];
            this.surveyTitle = card.title;
            this.surveyInstructions = card.instructions;
            this.surveyNumber = card.number;
            this.observables = card.observables.map( (label) => label );
            this.sections = generateModel(card);
          }
        },
        created() {
          this.populate();
        }
      });
    </script>
  </body>
</html>
