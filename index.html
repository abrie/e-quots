<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Title of the document</title>
    <script src="vue.js"></script>
    <style>
      body {
        --color-one: rgb(81,130,187);
        --color-two: rgb(237,242,248);
        --color-three: rgb(186, 205, 228);
        --color-four: rgb(245, 227, 83);
        --header-height: 3em;
      }
      div.header {
        display: flex;
        flex-direction: row;
        height: var(--header-height);
        position: relative;
        font-size: 1.5em;
        background: var(--color-one);
        border: 1px solid var(--color-one);
        align-items: center;
        color: white;
        border-radius: 0.25em 0 0 0.25em;
        overflow: hidden;
      }
      div.header div.logo {
        flex: 0 0 auto;
        height: var(--header-height);
        width: 4em;
        text-align: center;
        line-height: var(--header-height);
        border-right: 1px solid white;
        border-radius: 0.25em;
        overflow: hidden;
        padding-right: 0.25em;
        background: rgb(13,95,169);
          color: #ddd;
      }
      div.header div.title {
        padding-left: 0.5em;
        font-size: 0.95em;
      }
      div.header div.number {
        flex: 0 0 10%;
        background: var(--color-four);
        color: var(--color-one);
        height: 100%;
        text-align: center;
        line-height: var(--header-height);
        margin-left: auto;
      }
      div.instructions {
        padding: 1em;
          font-size: 0.75em;
      }
      div.checkbox {
        display: flex;
        flex-flow: row;
        flex-wrap: nowrap;
      }
      label.checkbox {
        flex: 1 1 auto;
      }
      input[type="checkbox"].checkbox {
        flex: 1 1 auto;
      }
      table {
        border: 1px solid var(--color-one);
      }
      td {
        border: 0px solid white;
      }
      th {
        background: var(--color-one);
        border: 1px solid white;
        color: white;
      }
      tr:nth-child(even) {
        background-color: var(--color-three);
      }
      tr:nth-child(odd) {
        background-color: var(--color-two);
      }

      button.export {
        font-variant: small-caps;
        font-size: 125%;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <div class="logo"><i>logo</i></div>
        <div class="title">{{ surveyTitle }}</div>
        <div class="number">{{ surveyNumber }}</div>
      </div>
      <div class="instructions">
        <b>Instructions</b>: {{ surveyInstructions }}
      </div>
      <table>
        <thead>
        <tr>
          <th rowspan="2" colspan="2">{{ questionHeader }}</th>
          <th rowspan="2" colspan="1" v-for="room in rooms">{{ room }}</th>
          <th rowspan="1" colspan="2"> Summary Of Observations </th>
        </tr>
        <tr>
        <th>Yes</th>
        <th>Total Observed</th>
        </tr>
        </thead>
        <tfoot>
          <th :colspan="rooms.length + 2">Total Yes and Total Observed</th>
          <td align="center"> {{ totalYes }} </td>
          <td align="center"> {{ totalObserved }}</td>
        </tfoot>
        <tbody>
        <tr v-for="(q, qIdx) in questions">
          <td>{{ q.number }}</td>
          <td>{{ q.text }}</td>
          <td v-for="(o, oIdx) in q.observations">
            <template v-for="(c, cIdx) in q.choices">
              <div class="checkbox">
                <input class="checkbox" id="checkbox_id(qIdx, oIdx, cIdx)" type="checkbox" v-model="o[c]" @change="enforceChoice(o, c)">
                <label class="checkbox" for="checkbox_id(qIdx, oIdx, cIdx)" >{{ c }}</label>
              </div>
            </template>
          </td>
          <td align="center">
            {{ countQuestionObservation(q, "Yes") }}
          </td>
          <td align="center">
            {{ countQuestionObserved(q) }}
          </td>
        </tr>
        </tbody>
      </table>
      <button class="export" @click="exportData">export</button>
    </div>
    <script>
      const cards = {
        "Isolation-Area-AIIR-Exterior-P": {
          number: 7,
          rooms: ["Room 1", "Room 2", "Room 3"],
          title: "Isolation: Observation of Area Exterior to Airborne Infection Isolation Rooms",
          instructions: "If there are any patients requiring Airborne Infection Isolation on unit, observe area outside of each isolation room. Observe each practice and record the observation. In the column on the right, sum (across) the total number of “Yes” and the total number of observations (“Yes” + “No”). Sum all categories (down) for overall performance.",
          questionHeader: "Isolation room: Observation Categories",
          questions: [
            {text:"Is an Airborne Infection Isolation sign at the patient's door?", choices:["Yes","No"]},
            {text:"Is the door to the room closed?", choices:["Yes","No"]},
            {text:"Does a manometer or other measurement mechanism indicate negative pressure in the room?", choices:["Yes","No"]},
            {text:"Are appropriate respirators}, (N-95) in multiple sizes and/or charged, powered air purifying respirators (PAPR), available?", choices:["Yes","No"]},
            {text:"Are respirators stored outside the room or in an anteroom?", choices:["Yes","No"]},
          ]
        },
        "Isolation-Area-Contact-Isolation-Exterior-P": {
          number: 6,
          rooms: ["Room 1", "Room 2", "Room 3"],
          title: "Isolation: Observation of Area Exterior to Contact Isolation Rooms",
          instructions: "Instructions: Observe areas outside of isolation rooms. Observe each practice and record the observation. In the column on the right, sum (across) the total number of “Yes” and the total number of observations (“Yes” + “No”). Sum all categories (down) for overall performance. Disregard not applicable categories. For example, cover gowns should be outside contact precautions rooms, but may not be required outside a room with airborne isolation precautions only.",
          questionHeader: "Isolation room: Observation Categories",
          questions: [
            {text:"Is an isolation sign at the patient’s door?", choices:["Yes","No"]},
            {text:"Are gloves available outside of each patient room or treatment area?", choices:["Yes","No","N/A"]},
            {text:"Are cover gowns available near each patient room or treatment area?", choices:["Yes","No"]},
            {text:"Is other PPE for standard precautions (e.g., eye protection, face masks) available near each patient room or treatment area?", choices:["Yes","No","N/A"]},
            {text:"Are surgical face masks or face shields or N95 respirators available near patient room?", choices:["Yes","No","N/A"]},
            {text:"Is dedicated patient equipment, such as stethoscopes or blood pressure cuffs, available?", choices:["Yes","No"]},
          ]
        },
        "Central-Venous-Catheter-Observation-P":{
          number: 1,
          rooms: ["Patient 1", "Patient 2", "Patient 3", "Patient 4"],
          title: "Central Venous Catheter: Observation",
          instructions: "Observe patients with central lines in place. Observe each practice and record the observation. In the column on the right, sum (across) the total number of “Yes” and the total number of observations (“Yes” + “No”). Sum all categories (down) for overall performance.",
          questionHeader: "Central catheter: Observation Categories",
          questions: [
            {text:"Is the dressing adhesive intact over the catheter insertion site and drainage contained? (This question is for all dressings, including chlorhexidine gluconate -CHG dressings)", choices:["Yes","No"]},
            {text:"Is the dressing dated and timed according to facility policy?", choices:["Yes","No"]},
            {text:"Is the catheter secured to reduce movement or tension?", choices:["Yes","No"]},
            {text:"Are the administration tubing sets labeled with the start date and time?", choices:["Yes","No"]},
            {text:"If the tubing set is labeled, is it within the specified date and time range for use?", choices:["Yes","No","N/A"]},
            {text:"Are all inactive ports capped according to facility policy?", choices:["Yes","No","N/A"]},
        ],
        },
        "Injection-Safety-Central-Med-Area-P":{
          number: 10,
          rooms: ["One"],
          title: "Injection Safety: Observation of Centralized Medication Area",
          instructions: "Observe medication preparation area. For each category, record the observation. Observe each practice below and answer Yes, No, or N/A. Sum all Yes and No responses. Divide by sum of “Yes”+”No”. Disregard not applicable categories.",
          questionHeader: "Medication preparation room: Observation Categories",
          questions: [
            {text:"If multi-dose injectable medications are present, is the medication container maintained in a dedicated medication preparation space?", choices:["Yes","No","N/A"]},
            {text:"Is the medication preparation area free of opened single dose vials or opened single use containers?", choices:["Yes","No"]},
            {text:"If open multi-dose vials are present, are they dated and within the Beyond Use Date (BUD) and the manufacturer’s expiration period?", choices:["Yes","No","N/A"]},
            {text:"Medications are prepared in a clean area free from contamination or contact with blood, body fluids, or contaminated equipment.", choices:["Yes","No"]},
            {text:"Are splash guards installed at sinks that are located close to medication prep areas?", choices:["Yes","No"]},
            {text:"Are sinks readily accessible to healthcare providers?", choices:["Yes","No"]},
            {text:"Are hand washing supplies, such as soap, and paper towels, available?", choices:["Yes","No"]},
            {text:"Are alcohol dispensers readily available, filled, and functioning properly?", choices:["Yes","No"]},
            ],
        },
        "Reprocessing-Clean-Area-Disinfection-Sterilization-P":{ //TODO
          number: 16,
          rooms: ["One"],
          title: "Reprocessing: High Level Disinfection and Liquid Sterilization Process– “Clean” Area",
          instructions: "Observe area where instruments are reprocessed. For each category, record the observation Sum all Yes and No responses. Divide by sum of “Yes” + ”No”.",
          questionHeader: "Equipment Reprocessing – Clean Area",
          questions: [
            {text:"Are disinfected instruments stored in a manner to protect them from damage and contamination?", choices:["Yes","No"]},
            {text:"Is each piece of equipment labeled with the day of most recent disinfection?", choices:["Yes","No"]},
            {text:"Are scopes, if present, stored in a dedicated area and hung vertically to facilitate drying?", choices:["Yes","No","N/A"]},
            {text:"Is a log of reprocessed items (paper-based or electronic) maintained that documents:", choices:["Yes","No"]},
            ],
        },
        "Cough-Courtesy-Waiting-Room-P": {
          number: 20,
          rooms: ["One"],
          title: "Cough Courtesy: Waiting Room",
          instructions: " Observe the ambulatory care point of care testing area. For each category, record the observation. Sum all Yes and No responses. Divide by sum of “Yes” + ”No”.",
          questionHeader: "Ambulatory Waiting Room: Observation Categories",
          questions: [
            {text:"As patients first register for care, is there visible signage instructing them to alert the staff of a respiratory infection?", choices:["Yes","No"]},
            {text:"Are face masks and tissues readily available for patients and visitors with respiratory or flu-like symptoms?", choices:["Yes","No"]},
            {text:"Are hand hygiene supplies readily available to visitors in the waiting room?", choices:["Yes","No"]},
            {text:"Are trash receptacles readily available to visitors in the waiting room?", choices:["Yes","No"]},
            ],
        },
        "Reprocessing-Dirty-Area-Disinfection-Sterilization-P": {
          number: 15,
          rooms: ["One"],
          title: "Reprocessing: High Level Disinfection and Liquid Sterilization Process– “Dirty” Area Using Chemical Soak Method",
          instructions: "Observe area where instruments are reprocessed by a soaking method using a liquid chemical germicide. For each category, record the observation. Sum all Yes and No responses. Divide by sum of “Yes” + ”No”.",
          questionHeader: "Equipment Reprocessing",
          questions: [
            {text:"Is the preprocessing “dirty” area separate from the clean area?", choices:["Yes","No"]},
            {text:"Is adequate space allotted for device inspection?", choices:["Yes","No"]},
            {text:"Are signs visible that include the reprocessing steps and recording requirements?", choices:["Yes","No"]},
            {text:"Is a traffic flow pattern from “soiled” to “clean” clearly delineated in the area in which technicians progress through their reprocessing tasks?", choices:["Yes","No"]},
            {text:"Is there a readily-available supply of personal protective equipment, including gloves, cover gowns, eye and face protection?", choices:["Yes","No"]},
            {text:"Is an eyewash station available within a 10 second travel distance from chemicals being used?", choices:["Yes","No"]},
            {text:"Is weekly eye wash station maintenance documented, including flushing and temperature validation (60° F to 100° F, or 16° C to 38 °C)?", choices:["Yes","No"]},
            ],
          questionHeader2: "Equipment Reprocessing – Dirty Area",
          questions2: [
            {text:"Are chemical potency test strips stored appropriately and labeled with “opened” and “use by” dates?", choices:["Yes","No"]},
            {text:"Are opened liquid chemical containers labeled with the date opened and the use-by date?", choices:["Yes","No"]},
            {text:"Do log books show test strip quality control recording?", choices:["Yes","No"]},
            {text:"Do log books show results of liquid chemical germicide potency testing?", choices:["Yes","No"]},
            {text:"Are spill kits readily available?", choices:["Yes","No"]},
            {text:"Are safety data sheets (SDS, formerly known as MSDS) available for the chemicals used in the area?", choices:["Yes","No"]},
            {text:"Are instrument instructions for use (IFUs) readily available for each equipment item reprocessed in the area?", choices:["Yes","No"]},
        ],
        },
      }
       const activeCard = "Reprocessing-Dirty-Area-Disinfection-Sterilization-P";

      function generateModel(survey) {
        return survey.questions.map( (q, idx) => {
          const text = q.text;
          const observations = [];
          const choices = q.choices.map( (c) => c );
          for (let i = 0; i < survey.rooms.length; i++) {
            const observation = {};
            q.choices.forEach( (choice) => observation[choice] = false );
            observations.push(observation);
          }

          return {number:idx+1, text, choices, observations}
        });
      }

      var app = new Vue({
        el: '#app',
        data: {
          questions: [],
        },
        computed: {
          totalYes() {
            return this.questions.reduce( (acc, q) => acc + this.countQuestionObservation(q,"Yes"), 0 )
          },
          totalObserved() {
            return this.questions.reduce( (acc, q) => acc + this.countQuestionObserved(q), 0 )
          },
        },
        methods: {
          label: (qIdx,rIdx,yesno) => `question-${qIdx}-room-${rIdx}-${yesno}`,
          enforceChoice(observation, which) {
            const others = Object.keys(observation).filter( (key) => key !== which );
            others.forEach( (other) => observation[other] = false );
          },
          countQuestionObservation: (q, choice) => q.observations.filter( (r) => r[choice] ).length,
          countQuestionObserved: (q) => q.observations.filter( (r) => r["Yes"] || r["No"] ).length,
          csvHeader() {
            const columns = [
              "Observation Number",
              "Observation Category",
              ...this.rooms,
              "'Yes' Observed",
              "Total Observed"
            ]
            return columns.join(",");
          },
          csvData() {
            return this.questions.map( (q, idx) => {
              const columns = [
                idx+1,
                `"${q.text}"`,
                ...q.rooms.map( (r) => {
                  return r["Yes"] ? "1" : "0";
                }),
                this.countQuestionObservation(q, "Yes"),
                this.countQuestionObserved(q),
                ];
              return columns.join(',');
            })
          },
          generateCSV() {
            const lines = [this.csvHeader(), ... this.csvData()];
            return lines.join("\n");
          },
          exportData() {
            const filename="demo.csv";
            const text = this.generateCSV();
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
          },
          populate() {
            const card = cards[activeCard];
            this.questionHeader = card.questionHeader;
            this.surveyTitle = card.title;
            this.surveyInstructions = card.instructions;
            this.surveyNumber = card.number;
            this.rooms = card.rooms.map( (label) => label );
            this.questions = generateModel(card);
          }
        },
        created() {
          this.populate();
        }
      });
    </script>
  </body>
</html>
